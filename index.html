<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡πÄ‡∏ß‡∏µ‡∏¢‡∏á ‡∏™‡∏µ‡πà‡∏ï‡πà‡∏≠ ‡∏™‡∏µ‡πà ‚Äî Game Show (Merged)</title>

<!-- Fonts + Chart -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0b1020; --card:#121a33; --gold:#ffd700; --green:#22c55e; --blue:#3b82f6;
  --text:#eaf0ff; --dim:#c6d3ff88; --border:#23305a; --bad:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Noto Sans Thai",system-ui,-apple-system,Segoe UI,Roboto,Thonburi,sans-serif}

header.top{
  position:sticky; top:0; z-index:20;
  background:#0b1020; border-bottom:1px solid var(--border);
  display:flex; gap:8px; padding:10px; align-items:center; flex-wrap:wrap;
}
header.top .brand{font-weight:900;color:var(--gold);letter-spacing:.3px;margin-right:6px}
header.top button{
  padding:6px 12px; border:none; border-radius:8px; background:#142045; color:#9fb1ff; cursor:pointer; font-weight:700;
}
header.top button.active{background:#1c2a50;color:var(--gold)}

.view{display:none; padding:16px}
.view.show{display:block}

.title{text-align:center;font-size:clamp(28px,6vw,56px);color:var(--gold);font-weight:900;margin:16px 0;text-shadow:0 3px 8px rgba(0,0,0,.35)}
.meta{text-align:center;color:var(--dim);margin-bottom:8px}

.question{
  font-size:clamp(20px,3.5vw,36px); text-align:center;
  margin:14px auto; padding:14px; border:2px solid var(--border); border-radius:16px;
  max-width:900px; background:#121a33;
}

.board{display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); max-width:1000px; margin:16px auto}
.card{perspective:1000px; cursor:pointer}
.inner{position:relative; height:110px; transition:transform .6s; transform-style:preserve-3d}
.card.revealed .inner{transform:rotateY(180deg)}
.side{position:absolute; inset:0; display:flex; justify-content:center; align-items:center; border-radius:14px; backface-visibility:hidden; padding:10px}
.front{background:#0f1733; color:var(--gold); font-weight:900; font-size:28px}
.back{background:#0f2a2a; color:var(--green); transform:rotateY(180deg); font-weight:800; font-size:20px; flex-direction:column}

.scoreboard{display:grid; grid-template-columns:1fr 1fr; gap:14px; max-width:1000px; margin:12px auto}
.team{background:#121a33; padding:12px; border-radius:14px}
.team h3{margin:0 0 8px; color:var(--gold)}
.score{font-size:clamp(32px,6vw,60px); font-weight:900; color:var(--green)}
.controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
.btn{padding:8px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700}
.btn.gold{background:#3a2a05; color:var(--gold)}
.btn.green{background:#0f2a1b; color:#bdf9cc}
.btn.red{background:#3a0f0f; color:var(--bad)}
.btn.ghost{background:#0f1733; color:#9fb1ff; border:1px solid #2a3a70}

.seg{display:inline-flex; border:1px solid #2a3a70; border-radius:8px; overflow:hidden}
.seg button{padding:8px 12px; background:#0f1733; color:#9fb1ff; border:none; cursor:pointer; font-weight:800}
.seg button.active{background:#1b2a58; color:var(--gold)}

.panel{background:#121a33; padding:14px; border-radius:14px; margin:14px 0}
.panel h2{margin:0 0 10px; color:var(--gold)}
.ans-row{display:grid; grid-template-columns:1fr 110px auto; gap:8px; margin-top:8px; align-items:center}
input,textarea,select{width:100%; padding:8px 10px; border-radius:8px; border:1px solid #2a3a70; background:#0f1730; color:var(--text)}



.center{text-align:center}
hr.sep{border:none;height:1px;background:linear-gradient(90deg,transparent,#2a3a70,transparent);margin:12px 0}

.result-grid{display:grid; grid-template-columns:1fr; gap:16px; max-width:1100px; margin:0 auto}
canvas{max-width:700px; margin:12px auto; display:block}
.details{background:#121a33; padding:12px; border-radius:10px; margin:10px 0}

.small{font-size:12px; color:#94a3ff}
</style>
</head>
<body>

<header class="top">
  <div class="brand">‡πÄ‡∏ß‡∏µ‡∏¢‡∏á ‡∏™‡∏µ‡πà‡∏ï‡πà‡∏≠ ‡∏™‡∏µ‡πà</div>
  <button id="tab-start" class="active">Start</button>
  <button id="tab-monitor">Monitor</button>
  <button id="tab-admin">Admin</button>
  <button id="tab-result">Result</button>
</header>

<!-- START VIEW -->
<main id="start" class="view show">
  <h1 class="title">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</h1>
  <div class="center">
    <p class="small">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <b>Admin</b> ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</p>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px">
      <button class="btn green" id="btnStartGame">‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
      <button class="btn red" id="btnResetGame">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏° (‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</button>
    </div>
  </div>
</main>

<!-- MONITOR VIEW -->
<main id="monitor" class="view">
  <h1 class="title">‡πÄ‡∏ß‡∏µ‡∏¢‡∏á ‡∏™‡∏µ‡πà‡∏ï‡πà‡∏≠ ‡∏™‡∏µ‡πà</h1>
  <div class="meta">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <b id="roundNo">1</b> / <span id="roundTotal">4</span> ‚Äî ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì: <b id="multLabel">x1</b></div>
  <div id="questionText" class="question">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
  <section id="board" class="board"></section>

  <!-- Strike system -->


  <section class="scoreboard">
    <div class="team">
      <h3>‡∏ó‡∏µ‡∏° A: <span id="teamAName">‡∏ó‡∏µ‡∏° A</span></h3>
      <div class="score" id="scoreA">0</div>
      <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b id="lastPtsA">0</b> √ó <b id="multA">1</b></div>
      <div class="controls">
        <button class="btn green" id="addA">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button class="btn red" id="subA">‚Äì ‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
      </div>
    </div>
    <div class="team">
      <h3>‡∏ó‡∏µ‡∏° B: <span id="teamBName">‡∏ó‡∏µ‡∏° B</span></h3>
      <div class="score" id="scoreB">0</div>
      <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b id="lastPtsB">0</b> √ó <b id="multB">1</b></div>
      <div class="controls">
        <button class="btn green" id="addB">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button class="btn red" id="subB">‚Äì ‡∏•‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
      </div>
    </div>
  </section>

  <div class="center" style="margin:10px 0">
    <div id="multSeg" class="seg">
      <button data-m="1" class="active">x1</button>
      <button data-m="2">x2</button>
      <button data-m="3">x3</button>
    </div>
  </div>

  <div class="center" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="btn gold" id="prevQ">‚üµ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <button class="btn gold" id="nextQ">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ü∂</button>
    <button class="btn ghost" id="resetBoard">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô</button>
    <button class="btn green" id="finishGame">‡∏à‡∏ö‡πÄ‡∏Å‡∏° & ‡∏î‡∏π‡∏ú‡∏•</button>
  </div>
  <p class="small center">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡πÉ‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏µ‡∏°‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏ß‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ</p>
</main>

<!-- ADMIN VIEW -->
<main id="admin" class="view">
  <h1 class="title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°</h1>
  <div class="panel">
    <h2>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</h2>
    <label>‡∏ó‡∏µ‡∏° A <input id="inTeamA" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô A"></label>
    <label>‡∏ó‡∏µ‡∏° B <input id="inTeamB" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏°‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô B"></label>
  </div>

  <div id="questions"></div>
  <div class="center" style="margin-top:6px">
    <button class="btn green" id="addRound">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö</button>
  </div>

  <hr class="sep" />

  <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
    <button class="btn ghost" id="loadData">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</button>
    <button class="btn green" id="saveData">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="btn red" id="clearData">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡πâ‡∏≤‡∏á localStorage)</button>
  </div>
</main>

<!-- RESULT VIEW -->
<main id="result" class="view">
  <h1 class="title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h1>
  <div id="winner" class="center" style="font-size:28px;color:var(--gold);margin:10px 0">üèÜ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ ...</div>

  <section class="result-grid">
    <canvas id="chartTotal"></canvas>
    <canvas id="chartA"></canvas>
    <canvas id="chartB"></canvas>

    <div class="center" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="btn green" id="btnShowA">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡∏° A</button>
      <button class="btn green" id="btnShowB">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡∏° B</button>
      <button class="btn gold" id="btnExport">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (JSON)</button>
    </div>
    <div id="teamDetails"></div>
  </section>

  <div class="center" style="margin-top:14px">
    <button class="btn red" id="btnPlayAgain">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</main>

<script>
/* ================== State & Persistence ================== */
const STORAGE_KEY = "ws44_data";
let data   = { teams:{A:"‡∏ó‡∏µ‡∏° A", B:"‡∏ó‡∏µ‡∏° B"}, rounds:[] };
let roundIndex = 0;
let multiplier = 1;
let lastPts = 0;
let lastCard = null;  // {id, answer, points, rank}
let usedCards = {};   // { cardId: "A"|"B" }
let scores = {A:0, B:0};
let strikes = 0;
let stats = [];       // [{team, round, answer, points, m, total, cardId, rank}]

const $ = id => document.getElementById(id);

/* ---- Init data from localStorage or default ---- */
function initData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ data = JSON.parse(raw) || data; } catch(e){}
  }
  if(!data.rounds) data.rounds = [];
  if(data.rounds.length === 0){
    for(let i=0;i<4;i++) data.rounds.push({question:"",answers:[]});
  }
}
initData();

/* ================== Navigation ================== */
function switchView(name){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("show"));
  document.querySelectorAll("header.top button").forEach(b=>b.classList.remove("active"));
  $(name).classList.add("show");
  $("tab-"+name).classList.add("active");
  if(name === "monitor") renderMonitor();
  else if(name === "admin") renderAdmin();
  else if(name === "result") renderResult();
}
$("tab-start").onclick  = ()=>switchView("start");
$("tab-monitor").onclick= ()=>switchView("monitor");
$("tab-admin").onclick  = ()=>switchView("admin");
$("tab-result").onclick = ()=>switchView("result");

/* ================== START view actions ================== */
$("btnStartGame").onclick = ()=>{
  // runtime reset (‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)
  scores = {A:0,B:0};
  usedCards = {};
  stats = [];
  roundIndex = 0;
  strikes = 0;
  lastPts = 0;
  lastCard = null;
  multiplier = 1;
  switchView("monitor");
};
$("btnResetGame").onclick = ()=>{
  if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)")){
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
    scores = {A:0, B:0};
    usedCards = {};
    stats = [];
    roundIndex = 0;
    strikes = 0;
    lastPts = 0;
    lastCard = null;
    multiplier = 1;
    renderAdmin();     // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°/‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
    renderMonitor();   // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Monitor
    switchView("start"); 
    alert("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)");
  }
};


/* ================== STRIKE system ================== */

/* ================== ADMIN ================== */
function renderAdmin(){
  $("inTeamA").value = data.teams.A || "‡∏ó‡∏µ‡∏° A";
  $("inTeamB").value = data.teams.B || "‡∏ó‡∏µ‡∏° B";
  const qwrap = $("questions");
  qwrap.innerHTML = "";
  data.rounds.forEach((r,ri)=>{
    const box = document.createElement("div");
    box.className = "panel";
    box.innerHTML = `
      <h2>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${ri+1}</h2>
      <label>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        <textarea data-ri="${ri}" class="qtext" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ">${r.question||""}</textarea>
      </label>
      <div id="ansbox-${ri}"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn green addAns" data-ri="${ri}">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        <button class="btn red delRound" data-ri="${ri}">üóë ‡∏•‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</button>
      </div>
    `;
    qwrap.appendChild(box);
    renderAnsBox(ri);
  });
}
function renderAnsBox(ri){
  const box = $("ansbox-"+ri);
  const arr = data.rounds[ri].answers||[];
  box.innerHTML = arr.map((a,ai)=>`
    <div class="ans-row">
      <input type="text" data-ri="${ri}" data-ai="${ai}" class="ansText" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö #${ai+1}" value="${a.text||""}">
      <input type="number" data-ri="${ri}" data-ai="${ai}" class="ansPts" value="${a.points||0}">
      <button class="btn red delAns" data-ri="${ri}" data-ai="${ai}">x</button>
    </div>
  `).join("");
}
/* bindings */
document.body.addEventListener("input", (e)=>{
  if(e.target.id==="inTeamA"){ data.teams.A = e.target.value||"‡∏ó‡∏µ‡∏° A"; }
  if(e.target.id==="inTeamB"){ data.teams.B = e.target.value||"‡∏ó‡∏µ‡∏° B"; }
  if(e.target.classList.contains("qtext")){
    const ri = +e.target.dataset.ri;
    data.rounds[ri].question = e.target.value;
  }
  if(e.target.classList.contains("ansText")){
    const {ri,ai} = e.target.dataset;
    data.rounds[ri].answers[ai].text = e.target.value;
  }
  if(e.target.classList.contains("ansPts")){
    const {ri,ai} = e.target.dataset;
    data.rounds[ri].answers[ai].points = parseInt(e.target.value)||0;
  }
});
document.body.addEventListener("click", (e)=>{
  if(e.target.classList.contains("addAns")){
    const ri = +e.target.dataset.ri;
    (data.rounds[ri].answers ||= []).push({text:"",points:0});
    renderAdmin();
  }
  if(e.target.classList.contains("delAns")){
    const {ri,ai} = e.target.dataset;
    data.rounds[ri].answers.splice(ai,1);
    renderAdmin();
  }
  if(e.target.classList.contains("delRound")){
    const ri = +e.target.dataset.ri;
    if(confirm("‡∏•‡∏ö‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ?")){ data.rounds.splice(ri,1); renderAdmin(); }
  }
});
$("addRound").onclick = ()=>{ data.rounds.push({question:"",answers:[]}); renderAdmin(); };
$("saveData").onclick = ()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß"); };
$("loadData").onclick = ()=>{ initData(); renderAdmin(); alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß"); };
$("clearData").onclick = ()=>{
  if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å localStorage?")){
    localStorage.removeItem(STORAGE_KEY);
    data = { teams:{A:"‡∏ó‡∏µ‡∏° A", B:"‡∏ó‡∏µ‡∏° B"}, rounds:[] }; initData(); renderAdmin();
  }
};

/* ================== MONITOR (play) ================== */
function renderMonitor(){
  $("teamAName").textContent = data.teams.A || "‡∏ó‡∏µ‡∏° A";
  $("teamBName").textContent = data.teams.B || "‡∏ó‡∏µ‡∏° B";
  $("roundTotal").textContent = data.rounds.length;
  if(roundIndex >= data.rounds.length) roundIndex = data.rounds.length-1;
  if(roundIndex < 0) roundIndex = 0;
  $("roundNo").textContent = roundIndex + 1;

  const r = data.rounds[roundIndex] || {question:"",answers:[]};
  $("questionText").textContent = r.question || "‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Äî";

  const sorted = [...(r.answers||[])]
        .map((a,i)=>({...a, id:`${roundIndex}-${i}`}))
        .sort((a,b)=>b.points - a.points);

  const board = $("board"); board.innerHTML = "";
  sorted.forEach((a,rankIdx)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="inner">
        <div class="side front">${rankIdx+1}</div>
        <div class="side back"><div>${a.text||"(‡∏ß‡πà‡∏≤‡∏á)"}</div><div>+ ${a.points||0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>
      </div>
    `;
    card.onclick = ()=>{
      if(!card.classList.contains("revealed")){
        card.classList.add("revealed");
        lastPts = a.points||0;
        lastCard = { id:`${roundIndex}-${rankIdx}`, answer:a.text||"", points:a.points||0, rank:rankIdx+1 };
        $("lastPtsA").textContent = lastPts;
        $("lastPtsB").textContent = lastPts;
        $("multA").textContent = multiplier;
        $("multB").textContent = multiplier;
      }
    };
    board.appendChild(card);
  });

  // reset per-round helpers
  strikes = 0; updateStrikes();
  lastPts = 0; lastCard = null;
  $("lastPtsA").textContent = "0"; $("lastPtsB").textContent = "0";
  $("multLabel").textContent = "x"+multiplier;
  $("multA").textContent = multiplier; $("multB").textContent = multiplier;

  updateScores();
}
function updateScores(){
  $("scoreA").textContent = scores.A;
  $("scoreB").textContent = scores.B;
}
/* add/sub with anti-double-score */
$("addA").onclick = ()=>{
  if(lastCard && !usedCards[lastCard.id]){
    const delta = lastCard.points * multiplier;
    scores.A += delta; usedCards[lastCard.id] = "A"; updateScores();
    stats.push({team:"A", round:roundIndex+1, answer:lastCard.answer, points:lastCard.points, m:multiplier, total:delta, cardId:lastCard.id, rank:lastCard.rank});
  }
};
$("addB").onclick = ()=>{
  if(lastCard && !usedCards[lastCard.id]){
    const delta = lastCard.points * multiplier;
    scores.B += delta; usedCards[lastCard.id] = "B"; updateScores();
    stats.push({team:"B", round:roundIndex+1, answer:lastCard.answer, points:lastCard.points, m:multiplier, total:delta, cardId:lastCard.id, rank:lastCard.rank});
  }
};
$("subA").onclick = ()=>{ if(lastCard){ scores.A = Math.max(0, scores.A - lastCard.points * multiplier); updateScores(); } };
$("subB").onclick = ()=>{ if(lastCard){ scores.B = Math.max(0, scores.B - lastCard.points * multiplier); updateScores(); } };

/* multiplier */
[...$("multSeg").children].forEach(btn=>{
  btn.onclick = ()=>{
    [...$("multSeg").children].forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    multiplier = parseInt(btn.dataset.m)||1;
    $("multLabel").textContent = "x"+multiplier;
    $("multA").textContent = multiplier; $("multB").textContent = multiplier;
  }
});

/* navigation */
$("prevQ").onclick = ()=>{ if(roundIndex>0){ roundIndex--; renderMonitor(); } };
$("nextQ").onclick = ()=>{
  if(roundIndex < data.rounds.length-1){ roundIndex++; renderMonitor(); }
  else { showResult(); }
};
$("resetBoard").onclick = ()=>{ renderMonitor(); };
$("finishGame").onclick = ()=> showResult();

/* ================== RESULT ================== */
let chartTotal, chartA, chartB;
function showResult(){ switchView("result"); }
function renderResult(){
  // winner text
  const winner = scores.A === scores.B ? "‡πÄ‡∏™‡∏°‡∏≠" : (scores.A > scores.B ? data.teams.A : data.teams.B);
  $("winner").textContent = `üèÜ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏∑‡∏≠ ${winner}`;

  // destroy previous charts if exists
  [chartTotal, chartA, chartB].forEach(c=>{ try{c && c.destroy();}catch(e){} });

  // Total chart
  chartTotal = new Chart($("chartTotal"), {
    type:"bar",
    data:{
      labels:[data.teams.A, data.teams.B],
      datasets:[{label:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°", data:[scores.A, scores.B], backgroundColor:[varCSS("--green"), varCSS("--blue")]}]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // Team A detailed answers
  const aStats = stats.filter(s=>s.team==="A");
  chartA = new Chart($("chartA"), {
    type:"bar",
    data:{
      labels:aStats.map(s=>`‡∏£${s.round}:${s.answer}`),
      datasets:[{label:`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏° ${data.teams.A} ‡πÑ‡∏î‡πâ`, data:aStats.map(s=>s.total), backgroundColor:varCSS("--green")}]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // Team B detailed answers
  const bStats = stats.filter(s=>s.team==="B");
  chartB = new Chart($("chartB"), {
    type:"bar",
    data:{
      labels:bStats.map(s=>`‡∏£${s.round}:${s.answer}`),
      datasets:[{label:`‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡∏° ${data.teams.B} ‡πÑ‡∏î‡πâ`, data:bStats.map(s=>s.total), backgroundColor:varCSS("--blue")}]
    },
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // details buttons
  $("btnShowA").onclick = ()=> showDetails("A");
  $("btnShowB").onclick = ()=> showDetails("B");
  $("btnExport").onclick = exportStats;
  $("btnPlayAgain").onclick = ()=>{ switchView("start"); };
}
function showDetails(team){
  const div = $("teamDetails");
  const isA = team === "A";
  const tname = isA ? data.teams.A : data.teams.B;
  const arr = stats.filter(s=>s.team===team);
  if(arr.length===0){ div.innerHTML = `<div class="details center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° ${tname}</div>`; return; }
  div.innerHTML = `<h3 class="center">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡∏° ${tname}</h3>` +
    arr.map(s=>`<div class="details">‡∏£‡∏≠‡∏ö ${s.round} ‚Ä¢ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${s.rank} ‚Ä¢ ‚Äú${escapeHTML(s.answer)}‚Äù ‚Üí +${s.points} √ó x${s.m} = <b>${s.total}</b></div>`).join("");
}
function exportStats(){
  const obj = {teams:data.teams, scores, stats};
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "wiang-4x4-stats.json"; a.click();
  URL.revokeObjectURL(url);
}

/* ================== Utils ================== */
function varCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// Initial renders
renderAdmin();
renderMonitor();
switchView("start");
</script>
</body>
</html>
